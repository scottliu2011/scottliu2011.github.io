<html>

<head>
  <style>
    body {
      margin: 10px;
    }

    body.paused {
      background: gainsboro;
    }

    section {
      position: fixed;
      top: 40%;
      left: 0;
      width: 100%;
    }

    div {
      font-size: 60px;
      text-align: center;
      color: slategrey;
    }
  </style>
</head>

<body>
  <audio id="audio"></audio>
  <button id="start">start</button>
  <section>
    <div id="en"></div>
    <div id="cn"></div>
  </section>
</body>
<script>
  const states = {
    sentences: [],
    nextIndex: 0,
    isPaused: false,
  };
  function fetchData() {
    const count = location.search.substring(1) || '100';
    return fetch(`./${count}.txt`).then((res) => {
      return res.text();
    }).then((text) => {
      const lines = text.split('\n\n');
      const sentences = lines.map((line) => {
        const [en, cn] = line.split('\n');
        return { en, cn };
      });
      return sentences.filter((sentence) => {
        return !!sentence.en;
      });
    });
  }
  function getAudio(sentence) {
    return `https://dict.youdao.com/dictvoice?type=1&audio=${encodeURIComponent(sentence)}`;
  }
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }
  function readSentence({ en, cn }) {
    document.getElementById('en').innerHTML = en;
    document.getElementById('cn').innerHTML = cn;

    audio.setAttribute('src', getAudio(en));
    audio.play();
  }
  function loopSentences(sentences) {
    const audio = document.getElementById('audio');

    states.nextIndex = 0;

    audio.addEventListener('ended', () => {
      states.nextIndex = (states.nextIndex + 1) % sentences.length;
      if (states.isPaused) {
        return;
      }
      setTimeout(() => {
        if (states.isPaused) {
          return;
        }
        readSentence(sentences[states.nextIndex]);
      }, 1000);
    });

    readSentence(sentences[states.nextIndex]);
  }
  document.getElementById('start').addEventListener('click', async () => {
    const sentences = await fetchData();
    shuffle(sentences);
    loopSentences(sentences);
    states.sentences = sentences;
  });
  document.addEventListener('keydown', (event) => {
    if (event.code === 'Space') {
      states.isPaused = !states.isPaused;
      if (states.isPaused) {
        document.body.classList.add('paused');
        const audio = document.getElementById('audio');
        audio.pause();
      } else {
        document.body.classList.remove('paused');
        readSentence(states.sentences[states.nextIndex]);
      }
    }
  });
</script>

</html>
