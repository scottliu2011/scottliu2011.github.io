<html>

<head>
  <style>
    body {
      margin: 10px;
    }

    body.paused {
      background: gainsboro;
    }

    section {
      position: fixed;
      top: 40%;
      left: 0;
      width: 100%;
    }

    div {
      font-size: 60px;
      text-align: center;
      color: slategrey;
    }
  </style>
</head>

<body>
  <button id="start">start</button>
  <section>
    <div id="en"></div>
    <div id="cn"></div>
  </section>
</body>
<script>
  const states = {
    sentences: [],
    audioIndex: 0,
    isPaused: false,
  };
  function fetchData() {
    const file = location.search.substring(1);
    return fetch(`https://scottliu2011.github.io/english/${file}.txt`).then((res) => {
      return res.text();
    }).then((text) => {
      const lines = text.split('\n\n');
      const sentences = lines.map((line) => {
        const [en, cn] = line.split('\n');
        return { en, cn };
      });
      return sentences.filter((sentence) => {
        return !!sentence.en;
      });
    });
  }
  function getAudio(sentence) {
    return `https://dict.youdao.com/dictvoice?type=1&audio=${encodeURIComponent(sentence)}`;
  }
  function shuffle(sentences) {
    for (let i = sentences.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [sentences[i], sentences[j]] = [sentences[j], sentences[i]];
    }
    return sentences;
  }
  function stepForward(step) {
    states.audioIndex = (states.audioIndex + step) % states.sentences.length;
    if (states.audioIndex < 0) {
      states.audioIndex = states.sentences.length - 1;
    }
  }
  function readSentence() {
    document.body.classList.remove('paused');

    const { en, cn } = states.sentences[states.audioIndex];

    document.getElementById('en').innerHTML = en;
    document.getElementById('cn').innerHTML = cn;

    const audio = document.getElementById(`audio${states.audioIndex}`);

    if (audio) {
      audio.play();
      return;
    }

    const newAudio = document.createElement('audio');

    newAudio.setAttribute('id', `audio${states.audioIndex}`);
    newAudio.setAttribute('src', getAudio(en));

    newAudio.addEventListener('ended', () => {
      stepForward(1);

      if (states.isPaused) {
        return;
      }

      setTimeout(() => {
        if (states.isPaused) {
          return;
        }
        readSentence();
      }, 1000);
    });
    newAudio.addEventListener('error', () => {
      newAudio.remove();
      setTimeout(() => {
        readSentence();
      }, 1000);
    });

    newAudio.play();

    document.body.appendChild(newAudio);
  }
  function pauseCurrentAudio(reset) {
    const audio = document.getElementById(`audio${states.audioIndex}`);
    if (audio) {
      audio.pause();
      if (reset) {
        audio.currentTime = 0;
      }
    }
  }
  document.getElementById('start').addEventListener('click', async (e) => {
    const sentences = await fetchData();
    states.sentences = shuffle(sentences);
    readSentence();
    e.target.remove();
  });
  document.addEventListener('keydown', (event) => {
    if (event.code === 'Space') {
      states.isPaused = !states.isPaused;
      if (states.isPaused) {
        document.body.classList.add('paused');
        pauseCurrentAudio();
      } else {
        readSentence();
      }
    } else if (event.code === 'ArrowLeft') {
      pauseCurrentAudio(true);
      stepForward(-1);
      readSentence();
    } else if (event.code === 'ArrowRight') {
      pauseCurrentAudio(true);
      stepForward(1);
      readSentence();
    }
  });
</script>

</html>
